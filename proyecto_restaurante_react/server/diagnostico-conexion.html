<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Diagn√≥stico de Conexi√≥n API</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .log-container {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 15px;
            max-height: 400px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
        }
        .log-success { color: #28a745; }
        .log-error { color: #dc3545; }
        .log-info { color: #007bff; }
        .log-warning { color: #ffc107; }
    </style>
</head>
<body>
    <div class="container mt-5">
        <div class="row justify-content-center">
            <div class="col-md-10">
                <div class="card">
                    <div class="card-header">
                        <h3>üîç Diagn√≥stico de Conexi√≥n API</h3>
                        <p class="mb-0">Sistema de Recuperaci√≥n de Contrase√±a</p>
                    </div>
                    <div class="card-body">
                        
                        <!-- Informaci√≥n del navegador -->
                        <div class="mb-4">
                            <h5>üåê Informaci√≥n del Navegador</h5>
                            <div class="row">
                                <div class="col-md-6">
                                    <p><strong>URL Actual:</strong> <span id="current-url"></span></p>
                                    <p><strong>User Agent:</strong> <span id="user-agent"></span></p>
                                </div>
                                <div class="col-md-6">
                                    <p><strong>Protocolo:</strong> <span id="protocol"></span></p>
                                    <p><strong>Host:</strong> <span id="host"></span></p>
                                </div>
                            </div>
                        </div>
                        
                        <!-- URLs de prueba -->
                        <div class="mb-4">
                            <h5>üîó URLs de Prueba</h5>
                            <div class="table-responsive">
                                <table class="table table-sm">
                                    <thead>
                                        <tr>
                                            <th>Endpoint</th>
                                            <th>URL</th>
                                            <th>Estado</th>
                                            <th>Acci√≥n</th>
                                        </tr>
                                    </thead>
                                    <tbody id="endpoints-table">
                                        <!-- Se llenar√° din√°micamente -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        
                        <!-- Log de pruebas -->
                        <div class="mb-4">
                            <h5>üìã Log de Pruebas</h5>
                            <div class="log-container" id="log-container">
                                <div class="log-info">Iniciando diagn√≥stico...</div>
                            </div>
                            <button class="btn btn-sm btn-outline-secondary mt-2" onclick="clearLog()">Limpiar Log</button>
                        </div>
                        
                        <!-- Botones de prueba -->
                        <div class="mb-4">
                            <h5>üß™ Pruebas Manuales</h5>
                            <div class="d-flex gap-2 flex-wrap">
                                <button class="btn btn-primary" onclick="testServerInfo()">Probar Info del Servidor</button>
                                <button class="btn btn-success" onclick="testRecuperarPassword()">Probar Recuperar Password</button>
                                <button class="btn btn-info" onclick="testMailConfig()">Probar Configuraci√≥n de Correo</button>
                                <button class="btn btn-warning" onclick="testDatabase()">Probar Base de Datos</button>
                            </div>
                        </div>
                        
                        <!-- Formulario de prueba -->
                        <div class="mb-4">
                            <h5>üìß Prueba de Recuperaci√≥n de Contrase√±a</h5>
                            <form id="test-form">
                                <div class="row">
                                    <div class="col-md-8">
                                        <input type="email" class="form-control" id="test-email" 
                                               placeholder="Ingresa un correo para probar" required>
                                    </div>
                                    <div class="col-md-4">
                                        <button type="submit" class="btn btn-primary w-100">Probar Env√≠o</button>
                                    </div>
                                </div>
                            </form>
                        </div>
                        
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // URLs base
        const baseUrl = window.location.origin + window.location.pathname.replace('diagnostico-conexion.html', '');
        const apiBaseUrl = baseUrl + 'api';
        
        // Elementos del DOM
        const logContainer = document.getElementById('log-container');
        const endpointsTable = document.getElementById('endpoints-table');
        
        // Inicializar p√°gina
        document.addEventListener('DOMContentLoaded', function() {
            initializePage();
            loadEndpoints();
            testServerInfo();
        });
        
        function initializePage() {
            document.getElementById('current-url').textContent = window.location.href;
            document.getElementById('user-agent').textContent = navigator.userAgent;
            document.getElementById('protocol').textContent = window.location.protocol;
            document.getElementById('host').textContent = window.location.host;
            
            log('info', 'P√°gina inicializada correctamente');
        }
        
        function loadEndpoints() {
            const endpoints = [
                {
                    name: 'Info del Servidor',
                    url: baseUrl + 'test-api-connection.php',
                    method: 'GET'
                },
                {
                    name: 'Recuperar Password',
                    url: apiBaseUrl + '/auth/recuperar-password.php?action=solicitar',
                    method: 'POST'
                },
                {
                    name: 'Test Mail',
                    url: baseUrl + 'test-mail.php',
                    method: 'GET'
                },
                {
                    name: 'Login',
                    url: apiBaseUrl + '/auth/login.php',
                    method: 'POST'
                }
            ];
            
            endpointsTable.innerHTML = '';
            endpoints.forEach(endpoint => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${endpoint.name}</td>
                    <td><code>${endpoint.url}</code></td>
                    <td><span class="badge bg-secondary" id="status-${endpoint.name.replace(/\s+/g, '-')}">Pendiente</span></td>
                    <td><button class="btn btn-sm btn-outline-primary" onclick="testEndpoint('${endpoint.name}', '${endpoint.url}', '${endpoint.method}')">Probar</button></td>
                `;
                endpointsTable.appendChild(row);
            });
        }
        
        async function testEndpoint(name, url, method) {
            const statusId = 'status-' + name.replace(/\s+/g, '-');
            const statusElement = document.getElementById(statusId);
            
            try {
                statusElement.className = 'badge bg-warning';
                statusElement.textContent = 'Probando...';
                
                log('info', `Probando ${name}: ${url}`);
                
                const options = {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json'
                    }
                };
                
                if (method === 'POST') {
                    options.body = JSON.stringify({ correo: 'test@test.com' });
                }
                
                const response = await fetch(url, options);
                
                if (response.ok) {
                    statusElement.className = 'badge bg-success';
                    statusElement.textContent = 'OK';
                    log('success', `‚úÖ ${name}: ${response.status} ${response.statusText}`);
                    
                    if (response.headers.get('content-type')?.includes('application/json')) {
                        const data = await response.json();
                        log('info', `Respuesta: ${JSON.stringify(data, null, 2)}`);
                    }
                } else {
                    statusElement.className = 'badge bg-danger';
                    statusElement.textContent = 'Error';
                    log('error', `‚ùå ${name}: ${response.status} ${response.statusText}`);
                }
                
            } catch (error) {
                statusElement.className = 'badge bg-danger';
                statusElement.textContent = 'Error';
                log('error', `‚ùå ${name}: ${error.message}`);
            }
        }
        
        async function testServerInfo() {
            try {
                log('info', 'Obteniendo informaci√≥n del servidor...');
                const response = await fetch(baseUrl + 'test-api-connection.php');
                const data = await response.json();
                
                log('success', 'Informaci√≥n del servidor obtenida');
                log('info', `PHP Version: ${data.server_info.php_version}`);
                log('info', `Server: ${data.server_info.server_software}`);
                log('info', `Document Root: ${data.server_info.document_root}`);
                
                // Verificar archivos
                Object.entries(data.files_status).forEach(([file, status]) => {
                    if (status.exists) {
                        log('success', `‚úÖ ${status.description}: ${file}`);
                    } else {
                        log('error', `‚ùå ${status.description}: ${file} - NO ENCONTRADO`);
                    }
                });
                
                // Verificar base de datos
                if (data.database_status.connected) {
                    log('success', '‚úÖ Base de datos conectada');
                    log('info', `Server Info: ${data.database_status.server_info}`);
                } else {
                    log('error', `‚ùå Error de base de datos: ${data.database_status.error}`);
                }
                
            } catch (error) {
                log('error', `Error al obtener informaci√≥n del servidor: ${error.message}`);
            }
        }
        
        async function testRecuperarPassword() {
            try {
                log('info', 'Probando recuperaci√≥n de contrase√±a...');
                const response = await fetch(apiBaseUrl + '/auth/recuperar-password.php?action=solicitar', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ correo: 'test@test.com' })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    log('success', '‚úÖ Recuperaci√≥n de contrase√±a funcionando');
                    log('info', `Mensaje: ${data.message}`);
                } else {
                    log('error', `‚ùå Error en recuperaci√≥n: ${data.message}`);
                }
                
            } catch (error) {
                log('error', `Error en recuperaci√≥n de contrase√±a: ${error.message}`);
            }
        }
        
        async function testMailConfig() {
            try {
                log('info', 'Probando configuraci√≥n de correo...');
                const response = await fetch(baseUrl + 'test-mail.php');
                
                if (response.ok) {
                    log('success', '‚úÖ P√°gina de prueba de correo accesible');
                } else {
                    log('error', `‚ùå Error al acceder a prueba de correo: ${response.status}`);
                }
                
            } catch (error) {
                log('error', `Error en configuraci√≥n de correo: ${error.message}`);
            }
        }
        
        async function testDatabase() {
            try {
                log('info', 'Probando conexi√≥n a base de datos...');
                const response = await fetch(baseUrl + 'test-api-connection.php');
                const data = await response.json();
                
                if (data.database_status.connected) {
                    log('success', '‚úÖ Base de datos conectada');
                    log('info', `Server: ${data.database_status.server_info}`);
                    log('info', `Client: ${data.database_status.client_info}`);
                    
                    if (data.database_status.password_reset_table_exists) {
                        log('success', '‚úÖ Tabla password_reset_codes existe');
                    } else {
                        log('warning', '‚ö†Ô∏è Tabla password_reset_codes NO existe');
                    }
                } else {
                    log('error', `‚ùå Error de base de datos: ${data.database_status.error}`);
                }
                
            } catch (error) {
                log('error', `Error al probar base de datos: ${error.message}`);
            }
        }
        
        // Formulario de prueba
        document.getElementById('test-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const email = document.getElementById('test-email').value;
            log('info', `Probando env√≠o de c√≥digo a: ${email}`);
            
            try {
                const response = await fetch(apiBaseUrl + '/auth/recuperar-password.php?action=solicitar', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ correo: email })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    log('success', '‚úÖ C√≥digo enviado exitosamente');
                    log('info', `Mensaje: ${data.message}`);
                } else {
                    log('error', `‚ùå Error al enviar c√≥digo: ${data.message}`);
                }
                
            } catch (error) {
                log('error', `Error de conexi√≥n: ${error.message}`);
            }
        });
        
        function log(type, message) {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.className = `log-${type}`;
            logEntry.textContent = `[${timestamp}] ${message}`;
            logContainer.appendChild(logEntry);
            logContainer.scrollTop = logContainer.scrollHeight;
        }
        
        function clearLog() {
            logContainer.innerHTML = '';
            log('info', 'Log limpiado');
        }
    </script>
</body>
</html>
