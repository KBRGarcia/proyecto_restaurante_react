<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Diagnóstico de APIs de Verificación</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .status-success { color: #28a745; }
        .status-error { color: #dc3545; }
        .status-warning { color: #ffc107; }
        .log-entry { 
            background: #f8f9fa; 
            padding: 10px; 
            margin: 5px 0; 
            border-radius: 5px; 
            font-family: monospace; 
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div class="container mt-5">
        <div class="row">
            <div class="col-md-12">
                <h1 class="mb-4">🔍 Diagnóstico de APIs de Verificación</h1>
                
                <div class="card">
                    <div class="card-header">
                        <h5>Configuración del Proyecto</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <strong>URL Base:</strong> <span id="baseUrl"></span><br>
                                <strong>Endpoint de Verificación:</strong> <span id="verificationUrl"></span>
                            </div>
                            <div class="col-md-6">
                                <strong>Timestamp:</strong> <span id="timestamp"></span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card mt-3">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5>Pruebas de Conectividad</h5>
                        <button class="btn btn-primary" onclick="runDiagnostics()">Ejecutar Diagnóstico</button>
                    </div>
                    <div class="card-body">
                        <div id="diagnosticResults"></div>
                    </div>
                </div>

                <div class="card mt-3">
                    <div class="card-header">
                        <h5>Log de Actividad</h5>
                    </div>
                    <div class="card-body">
                        <div id="activityLog"></div>
                    </div>
                </div>

                <div class="card mt-3">
                    <div class="card-header">
                        <h5>Prueba Manual del Endpoint</h5>
                    </div>
                    <div class="card-body">
                        <form id="testForm">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="testEmail" class="form-label">Email de Prueba</label>
                                        <input type="email" class="form-control" id="testEmail" value="test@example.com">
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="testPassword" class="form-label">Contraseña de Prueba</label>
                                        <input type="password" class="form-control" id="testPassword" value="test123">
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="testNombre" class="form-label">Nombre</label>
                                        <input type="text" class="form-control" id="testNombre" value="Test">
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="testApellido" class="form-label">Apellido</label>
                                        <input type="text" class="form-control" id="testApellido" value="User">
                                    </div>
                                </div>
                            </div>
                            <button type="submit" class="btn btn-success">Probar Endpoint</button>
                        </form>
                        <div id="testResults" class="mt-3"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Configuración
        const baseUrl = 'http://localhost/codigos-ika-XAMPP/proyecto_restaurante_react/proyecto_restaurante_react/server/api';
        const verificationUrl = `${baseUrl}/auth/send-verification-code.php`;
        
        // Mostrar configuración
        document.getElementById('baseUrl').textContent = baseUrl;
        document.getElementById('verificationUrl').textContent = verificationUrl;
        document.getElementById('timestamp').textContent = new Date().toLocaleString();

        function log(message, type = 'info') {
            const logDiv = document.getElementById('activityLog');
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry status-${type}`;
            logEntry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            logDiv.appendChild(logEntry);
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        async function runDiagnostics() {
            log('Iniciando diagnóstico completo...', 'info');
            
            try {
                // 1. Probar script simple primero
                log('Probando conectividad básica...', 'info');
                const simpleResponse = await fetch(`${baseUrl}/simple-test.php`);
                const simpleData = await simpleResponse.json();
                
                log('Conectividad básica OK', 'success');
                
                // 2. Probar rutas de archivos
                log('Probando rutas de archivos...', 'info');
                const pathsResponse = await fetch(`${baseUrl}/test-paths.php`);
                const pathsText = await pathsResponse.text();
                
                try {
                    const pathsData = JSON.parse(pathsText);
                    log('Rutas verificadas correctamente', 'success');
                    log('Detalles: ' + JSON.stringify(pathsData.checks, null, 2), 'info');
                } catch (parseError) {
                    log('Error parseando respuesta de rutas: ' + parseError.message, 'error');
                    log('Contenido recibido: ' + pathsText.substring(0, 200) + '...', 'error');
                }
                
                // 3. Probar script de configuración general
                log('Probando configuración general...', 'info');
                const configResponse = await fetch(`${baseUrl}/test-verification-setup.php`);
                
                if (!configResponse.ok) {
                    throw new Error(`HTTP ${configResponse.status}: ${configResponse.statusText}`);
                }
                
                const configText = await configResponse.text();
                log(`Respuesta recibida (${configText.length} caracteres)`, 'info');
                
                try {
                    const configData = JSON.parse(configText);
                    displayResults('config', configData);
                    log('Configuración general verificada', 'success');
                } catch (parseError) {
                    log(`Error parseando JSON: ${parseError.message}`, 'error');
                    log(`Contenido recibido: ${configText.substring(0, 500)}...`, 'warning');
                    displayError('config', parseError);
                }
                
                // 5. Probar endpoint de recuperación de contraseña
                log('Probando endpoint de recuperación de contraseña...', 'info');
                const recoveryResponse = await fetch(`${baseUrl}/test-password-recovery.php`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({})
                });
                
                if (!recoveryResponse.ok) {
                    throw new Error(`HTTP ${recoveryResponse.status}: ${recoveryResponse.statusText}`);
                }
                
                const recoveryText = await recoveryResponse.text();
                log(`Respuesta de recuperación recibida (${recoveryText.length} caracteres)`, 'info');
                
                try {
                    const recoveryData = JSON.parse(recoveryText);
                    log('Endpoint de recuperación verificado correctamente', 'success');
                    log('Detalles: ' + JSON.stringify(recoveryData.checks, null, 2), 'info');
                } catch (parseError) {
                    log('Error parseando respuesta de recuperación: ' + parseError.message, 'error');
                    log('Contenido recibido: ' + recoveryText.substring(0, 200) + '...', 'error');
                }
                
                // 6. Probar script específico de verificación
                log('Probando endpoint específico...', 'info');
                const verificationResponse = await fetch(`${baseUrl}/test-send-verification.php`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({})
                });
                
                if (!verificationResponse.ok) {
                    throw new Error(`HTTP ${verificationResponse.status}: ${verificationResponse.statusText}`);
                }
                
                const verificationText = await verificationResponse.text();
                
                try {
                    const verificationData = JSON.parse(verificationText);
                    displayResults('verification', verificationData);
                    log('Endpoint específico verificado', 'success');
                } catch (parseError) {
                    log(`Error parseando JSON: ${parseError.message}`, 'error');
                    log(`Contenido recibido: ${verificationText.substring(0, 500)}...`, 'warning');
                    displayError('verification', parseError);
                }
                
            } catch (error) {
                log(`Error en diagnóstico: ${error.message}`, 'error');
                displayError('diagnostic', error);
            }
        }

        function displayResults(type, data) {
            const resultsDiv = document.getElementById('diagnosticResults');
            
            const card = document.createElement('div');
            card.className = 'card mb-3';
            
            const header = document.createElement('div');
            header.className = 'card-header';
            header.innerHTML = `<h6>Resultados de ${type === 'config' ? 'Configuración General' : 'Endpoint Específico'}</h6>`;
            
            const body = document.createElement('div');
            body.className = 'card-body';
            
            if (data.checks) {
                const checksHtml = Object.entries(data.checks).map(([key, check]) => {
                    const statusClass = check.status === 'exists' || check.status === 'available' || check.status === 'connected' 
                        ? 'status-success' 
                        : check.status === 'error' || check.status === 'missing' || check.status === 'failed'
                        ? 'status-error'
                        : 'status-warning';
                    
                    return `<div class="mb-2">
                        <strong>${key}:</strong> 
                        <span class="${statusClass}">${check.status}</span>
                        ${check.error ? `<br><small class="text-danger">${check.error}</small>` : ''}
                        ${check.path ? `<br><small class="text-muted">${check.path}</small>` : ''}
                    </div>`;
                }).join('');
                
                body.innerHTML = checksHtml;
            }
            
            if (data.recommendations && data.recommendations.length > 0) {
                const recommendationsHtml = data.recommendations.map(rec => 
                    `<div class="alert alert-warning">${rec}</div>`
                ).join('');
                body.innerHTML += recommendationsHtml;
            }
            
            card.appendChild(header);
            card.appendChild(body);
            resultsDiv.appendChild(card);
        }

        function displayError(type, error) {
            const resultsDiv = document.getElementById('diagnosticResults');
            
            const card = document.createElement('div');
            card.className = 'card mb-3 border-danger';
            
            const header = document.createElement('div');
            header.className = 'card-header bg-danger text-white';
            header.innerHTML = `<h6>Error en ${type}</h6>`;
            
            const body = document.createElement('div');
            body.className = 'card-body';
            body.innerHTML = `<div class="alert alert-danger">${error.message}</div>`;
            
            card.appendChild(header);
            card.appendChild(body);
            resultsDiv.appendChild(card);
        }

        // Manejar formulario de prueba
        document.getElementById('testForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const testData = {
                email: document.getElementById('testEmail').value,
                password: document.getElementById('testPassword').value,
                nombre: document.getElementById('testNombre').value,
                apellido: document.getElementById('testApellido').value,
                codigo_area: '0414',
                numero_telefono: '1234567'
            };
            
            log('Enviando prueba al endpoint...', 'info');
            
            try {
                const response = await fetch(verificationUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(testData)
                });
                
                const data = await response.json();
                
                const resultsDiv = document.getElementById('testResults');
                resultsDiv.innerHTML = `
                    <div class="alert ${data.success ? 'alert-success' : 'alert-danger'}">
                        <h6>Respuesta del Endpoint:</h6>
                        <pre>${JSON.stringify(data, null, 2)}</pre>
                    </div>
                `;
                
                log(`Respuesta recibida: ${data.success ? 'Éxito' : 'Error'}`, data.success ? 'success' : 'error');
                
            } catch (error) {
                const resultsDiv = document.getElementById('testResults');
                resultsDiv.innerHTML = `
                    <div class="alert alert-danger">
                        <h6>Error de Conexión:</h6>
                        <p>${error.message}</p>
                    </div>
                `;
                
                log(`Error de conexión: ${error.message}`, 'error');
            }
        });

        // Ejecutar diagnóstico automáticamente al cargar
        window.addEventListener('load', () => {
            log('Página cargada, listo para diagnóstico', 'info');
        });
    </script>
</body>
</html>
